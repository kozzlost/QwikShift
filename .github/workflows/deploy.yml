name: Deploy to Production

on:
  push:
      branches: [ main ]
        workflow_run:
            workflows: ["CI/CD Pipeline"]
                types: [completed]
                    branches: [main]

                    env:
                      REGISTRY: ghcr.io
                        IMAGE_NAME: ${{ github.repository }}

                        jobs:
                          deploy:
                              name: Deploy to Production
                                  runs-on: ubuntu-latest
                                      if: github.event_name == 'push' && github.ref == 'refs/heads/main'

                                              permissions:
                                                    contents: read
                                                          packages: read

                                                                  environment:
                                                                        name: production
                                                                              url: https://zipshift.app

                                                                                      steps:
                                                                                            - name: Checkout code
                                                                                                    uses: actions/checkout@v3
                                                                                                          
                                                                                                                - name: Pull Docker image
                                                                                                                        run: |
                                                                                                                                  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
                                                                                                                                        
                                                                                                                                              - name: Deploy to Heroku
                                                                                                                                                      uses: AkhileshNS/heroku-deploy@v3.12.12
                                                                                                                                                              with:
                                                                                                                                                                        heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
                                                                                                                                                                                  heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
                                                                                                                                                                                            heroku_email: ${{ secrets.HEROKU_EMAIL }}
                                                                                                                                                                                                      usedocker: true
                                                                                                                                                                                                              env:
                                                                                                                                                                                                                        HD_MONGODB_URI: ${{ secrets.MONGODB_URI }}
                                                                                                                                                                                                                                  HD_JWT_SECRET: ${{ secrets.JWT_SECRET }}
                                                                                                                                                                                                                                            HD_STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
                                                                                                                                                                                                                                                      HD_SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                  - name: Deploy frontend to Netlify
                                                                                                                                                                                                                                                                          run: |
                                                                                                                                                                                                                                                                                    npm install -g netlify-cli
                                                                                                                                                                                                                                                                                              npm run build
                                                                                                                                                                                                                                                                                                        netlify deploy --prod --dir=dist
                                                                                                                                                                                                                                                                                                                env:
                                                                                                                                                                                                                                                                                                                          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
                                                                                                                                                                                                                                                                                                                                    NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
                                                                                                                                                                                                                                                                                                                                              REACT_APP_API_URL: https://api.zipshift.app
                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                          - name: Health check
                                                                                                                                                                                                                                                                                                                                                                  run: |
                                                                                                                                                                                                                                                                                                                                                                            for i in {1..30}; do
                                                                                                                                                                                                                                                                                                                                                                                        echo "Health check attempt $i..."
                                                                                                                                                                                                                                                                                                                                                                                                    if curl -f https://zipshift.app/health; then
                                                                                                                                                                                                                                                                                                                                                                                                                  echo "‚úì Application is healthy"
                                                                                                                                                                                                                                                                                                                                                                                                                                exit 0
                                                                                                                                                                                                                                                                                                                                                                                                                                            fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                        sleep 10
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  done
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "‚úó Application health check failed"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      exit 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - name: Notify deployment success
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if: success()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  uses: 8398a7/action-slack@v3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    status: success
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              text: '‚úì Deployment to production successful! üöÄ'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  fields: repo,message,commit,author
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: Notify deployment failure
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if: failure()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              uses: 8398a7/action-slack@v3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                status: failure
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          text: '‚úó Deployment to production failed! ‚ö†Ô∏è'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    webhook_url: ${{ secrets.SLACK_WEBHOOK }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              fields: repo,message,commit,author
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Rollback on failure
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  rollback:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      name: Rollback Deployment
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              needs: deploy
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if: failure()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          steps:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - name: Rollback Heroku deployment
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  heroku releases:rollback -a ${{ secrets.HEROKU_APP_NAME }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          env:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - name: Notify rollback
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        uses: 8398a7/action-slack@v3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          status: custom
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    custom_payload: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              text: '‚ö†Ô∏è Deployment rollback initiated',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            attachments: [{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            color: 'danger',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            text: 'The deployment failed and was rolled back to the previous version'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                webhook_url: ${{ secrets.SLACK_WEBHOOK }}
